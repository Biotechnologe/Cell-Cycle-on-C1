---
title: "Fluorescence measured in ImageJ"
output: html_document
date: "Friday, January 23, 2015"
---
```{r}
library(knitr)
opts_chunk$set(fig.width=10)
options(width=120)

scriptname <- "SetArea_Measure_UserConfirm.ijm"
pdfname <- "Usage_of_ImageJ_macro_SetArea_Measure_UserConfirm.pdf"
results_em <- "Results_SetArea_Measure_UserConfirm_EM.txt"
results_mb <- "Results_SetArea_Measure_UserConfirm_MB.txt"
```

##Summary

Images were taken of FUCCI cells on C1 before lysis in three channels: bright field, green and red. [Raw images](https://briefcase.riken.jp/public/mAF8gAzoLsdAVPwBXp1LS5HJzGlicAWQZwlMer8hKu5U) in the C01 format were used for measuring fluorescence and reporting errors in [ImageJ](http://imagej.net/Welcome) version 1.49m by using a macro [`r scriptname`](`r scriptname`). The usage of this macro is illustrated in the accompanying PDF file [`r pdfname`](`r pdfname`). The macro will ask the user to select a folder, which contains raw image files. Following procedures are done:  

* Open images one by one: first bright field, followed by green and followed by red channel images.
* Draw circular area on the bright field image with the diameter of 13 pixels
* Open dialogue box and and wait for user to drag the circle to the position of the cell on the brigh field image
* Measure fluorescence intensities on this defined area for green and red channels, and measure background intensity levels 100 x 50 pixels adjacent to the cell unless position is changed by the user
* Open dialogue box and ask the user for error report: comment and error type.
* Record the file name, coordinates, Size of area, Mean intnsity, Standard Deviation, Minimum and Maximum intensities and Error report
* Repeat the previous steps for every set of three images in the folder

The ImageJ macro was run independently by Elo Madissoon, EM (file [`r results_em`](`r results_em`)) and Michael Böttcher, MB (file [`r results_mb`](`r results_mb`)). The current document explains the [column names](#names) in the results files, analyzes the [consistency](#consistency) of the measurements, compares and finds consensus in the [error reporting](#errorreport) and gives an [overview](#overview) of the final values.

###<a name='names'>Column names</a>

####Label
Identifier of the well, which is the common part of the filename for all channels (bright field, red and green)

####Cellcoord.X and Cellcoord.Y
Pixel coordinates of the upper left corner of the smallest rectangle that completely contain the selection area.

####area
Size of the selection area.

####mean, std, min, max
Mean, standard deviation, minimum and maximum fluorescence intensity in the selection. Corresponding measurements to the background area (adjacent to the cell) when prefix is "bg." and to green channel or red channel when the suffix is ".ch2" or ".ch3" correspondingly.

####Error
Type of the error in the file with error report. Either "0-No Error" (default), "1-No cell", "2-Debris", "3-OutOfFocus","4-MultipleCells"

####Comment
Free text. Mostly commented if not sure about error type. Deafults to "No comment"


###<a name='consistency'>Consistency of ImageJ measurements</a>

Load the fluorescence results files. Summarize the content.

```{r}
#Pairwise correlation matrix from SourceForge.net:
panel.cor <- function(x, y, digits=2, prefix="", cex.cor) 
{
    usr <- par("usr"); on.exit(par(usr)) 
    par(usr = c(0, 1, 0, 1)) 
    r <- abs(cor(x, y)) 
    txt <- format(c(r, 0.123456789), digits=digits)[1] 
    txt <- paste(prefix, txt, sep="") 
    if(missing(cex.cor)) cex <- 0.8/strwidth(txt) 
 
    test <- cor.test(x,y) 
    # borrowed from printCoefmat
    Signif <- symnum(test$p.value, corr = FALSE, na = FALSE, 
                  cutpoints = c(0, 0.001, 0.01, 0.05, 0.1, 1),
                  symbols = c("***", "**", "*", ".", " ")) 
 
    text(0.5, 0.5, txt, cex = cex * r) 
    text(.8, .8, Signif, cex=cex, col=2) 
}


em=read.table(results_em,header=TRUE,sep="\t",row.names=1)
mb=read.table(results_mb,header=TRUE,sep="\t",row.names=1)
summary(em)
colnames(mb)
```


The cell location was set manually every time on the bright field image. The correalation of the cell coordinates will reflect reproducibility of the cell location determination. The correlation in fluorescence measures reflects reproducibility of the results. Correlation between cell coordinates and fluorescence values are plotted, colored by Run.

```{r}
subb <- substr(em$Label,1,12)
mfrow.orig <- par(mfrow=c(1,2))
plot(em$Cellcoord.X,mb$Cellcoord.X,col=as.factor(subb),main="Correlation of the X-coordinates",xlab="EM",ylab="MB")
legend("topleft",legend=c(levels(as.factor(subb))),pch=1,col=c(1:5))
plot(em$Cellcoord.Y,mb$Cellcoord.Y,col=as.factor(subb),main="Correlation of the Y-coordinates",xlab="EM",ylab="MB")
legend("topleft",legend=c(levels(as.factor(subb))),pch=1,col=c(1:5))
plot(em$mean.ch2,mb$mean.ch2,main="Correlation of measures in Ch2",xlab="EM",ylab="MB")
legend("topleft",legend=c(levels(as.factor(subb))),pch=1,col=c(1:5))
plot(em$mean.ch3,mb$mean.ch3,main="Correlation of measures in Ch3",xlab="EM",ylab="MB")
legend("topleft",legend=c(levels(as.factor(subb))),pch=1,col=c(1:5))
```


The cell loacation and fluorescence mean values correlate with each other between the two repeated measurements.  

The mean, minimum,maximum and standard deviation are expected to correlate between themselves in both green and red channel and between the two independent scorings.

```{r, fig.height=7}
pairs(cbind(em.mean=em$mean.ch2,mb.mean=mb$mean.ch2,em.min=em$min.ch2,em.min=mb$min.ch2,em.max=em$max.ch2,mb.max=mb$max.ch2,em.std=em$std.ch2,mb.std=mb$std.ch2), lower.panel=panel.smooth, upper.panel=panel.cor,main="Comparison of values in Channel 2, green")
pairs(cbind(em.mean=em$mean.ch3,mb.mean=mb$mean.ch3,em.min=em$min.ch3,em.min=mb$min.ch3,em.max=em$max.ch3,mb.max=mb$max.ch3,em.std=em$std.ch3,mb.std=mb$std.ch3), lower.panel=panel.smooth, upper.panel=panel.cor,main="Comparison of values in Channel 3, red")
```

Mean, maximum and standard deviation correlate well with each other in both channels for both scorings. The minimum values are not correlating as good. This can be explained by lower range of values and different distribution of fluorescence values inside the cell: The middle and nucleus of the cell is more fluorescent, while the membrane of the cell does not have any fluorescence in well focused images. 

Compare the intensity levels of fluroescence in respect to the error type and background.

```{r,fig.height=4}
par(mfrow <- c(2,2))
mar.orig <- par(mar=c(5.1,10.0, 4.1, 2.1))

flBoxplot <- function (DATA){
  title.2=paste("Fluorescence by ",deparse(substitute(DATA)),", green",sep="")
  title.3=paste("Fluorescence by ",deparse(substitute(DATA)),", red",sep="")
  y=c(as.character(DATA[,"Error"]),rep("background",nrow(DATA)))
  x.ch2=c(DATA[,"mean.ch2"],DATA[,"bg.mean.ch2"])
  x.ch3=c(DATA[,"mean.ch3"],DATA[,"bg.mean.ch3"])
  boxplot( x.ch2~y, main=title.2, las=1, horizontal=TRUE)
  boxplot( x.ch3~y, main=title.3, las=1, horizontal=TRUE)
}

flBoxplot(em)
flBoxplot(mb)

```

The low fluorescence value in wells with error *1-No cell* is expected and is similar to the background levels of fluorescence in both green and red channel. Cells classified as *2-Debris* could be defragmented cells, which have not lost their fluroescence, therefore the values are varying. The boxplots indicate that error report are different for *2-Debris* definition between two scorings. Compare the individual Error reports.


###<a name='errorreport'>Error report</a>

Observe the number of similar and different error scores between EM and MB. Observe the number of various classifications for both scorings.

```{r}
summary(em$Error==mb$Error)
cbind(em.error=summary(em$Error),mb.error=summary(mb$Error))
```


Error reporting differs between observers. Display the wells where reports differ, but at least one report has "0-No Error". Add "comment"column from MB, since there were no comments from EM for these cells.

```{r}
#Error report differs:
diff=em$Error!=mb$Error
differ=cbind(cell=as.character(em$Label),em.comment=as.character(em$Comment),em.error=as.character(em$Error),mb.error=as.character(mb$Error),mb.comment=as.character(substr(mb$Comment,1,45)))[diff,]
difference=differ[(differ[,"em.error"]=="0-No Error")|(differ[,"mb.error"]=="0-No Error"),]
levels(as.factor(difference[,"em.comment"]))
length(levels(as.factor(difference[,"mb.comment"])))
d=data.frame(difference[order(difference[,"em.error"]),-2])
d
```

There is inconsistency with error reporting for `r ncol(d)` cells. Third opinion was asked from JS and TK and consensus was achieved for the cells with at least one *0-No Error* by EM or MB. All the cells with error *4-MultipleCells* by either EM or MB were decided to score as *0-No Error*. Six cells with *3-OutOfFocus* were decided to keep as *3-OutOfFocus* and five cells re-scored as *0-No Error*. 13 more cells with various errors were dicussed. The new scoring for cells with non-consensus was done as follows:

```{r}
d$error=d$mb.error
d$error=as.matrix(d$error)
d$error[d$mb.error=="4-MultipleCells",] <- "0-No Error"
Consensus_OutOfFocus=c("1772-062-248_C03","1772-062-248_C04","1772-062-248_C05","1772-062-248_C10","1772-062-248_D06","1772-062-248_D08")
d$error[match(Consensus_OutOfFocus,d$cell),] <- "3-OutOfFocus"
Consensus_Discard=c("1772-062-248_B04","1772-062-249_C08","1772-062-038_G03","1772-062-249_E06","1772-062-103_C01","1772-062-038_D12")
d$error[match(Consensus_Discard,d$cell),] <- "2-Debris"
Consensus_Keep=c("1772-062-249_C11","1772-062-249_E08","1772-062-103_E03", "1772-062-039_H12","1772-062-038_F09","1772-067-038_H10","1772-062-248_D09")
d$error[match(Consensus_Keep,d$cell),] <- "0-No Error"

d[,c(-4)]
```

Use report by EM for final fluorescence values. Prepare additional columns for Run and Well. Rename errors in Error column to match the consensus error report. Add discard column for wells with consensus errors and outliers (fluorescence > 200). 


```{r}
em$Well <- substr(em$Label,14,16)
em$Run <- as.factor(paste(substr(subb,1,4),substr(subb,6,8),substr(subb,10,13),sep="-"))
em$Well <- as.factor(em$Well)
em$Error[match(d$cell,em$Label)] <- d$error
em$discard=FALSE
em[em$Error!="0-No Error","discard"] <- TRUE  
em[em$mean.ch3>200,"discard"] <- TRUE
em[em$mean.ch2>200,"discard"] <- TRUE

```

###<a name='overview'>Overview and Conclusions</a>

* The ImageJ macro produces reproducible results in the X and Y coordinates and in the mean values of fluorescence
* The mean, standard deviation and maxium values correlate well with each other in both the green and the red channels* A consensus was achieved with respect to the error type
* Fluorescence table was saved as *Results_fluorescence.txt*

```{r}
summary(em)
write.table(em, "Results_fluorescence.csv", sep=",")
sessionInfo()
```
